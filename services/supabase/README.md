# Supabase Service - Harmonia

This document provides instructions for developers to set up and run the Supabase service locally within the Harmonia monorepo.

---

## 🚧 Prerequisites

Make sure you have the following installed:

- [Node.js](https://nodejs.org/)
- [Bun](https://bun.sh/)
- [Docker](https://docs.docker.com/get-docker/)
- [Docker Compose](https://docs.docker.com/compose/install/)
- [Supabase CLI](https://supabase.com/docs/guides/local-development)

---

## ⚙️ Setup

1. **Clone the Repository**

```sh
git clone https://github.com/your-username/harmonia-dapp.git
cd harmonia-dapp/services/supabase
```

2. **Install Dependencies**

```sh
bun install
```

3. **Create Environment Variables**

```sh
cp .env.sample .env
```

Fill in the values:

```env
SUPABASE_PROJECT_ID=harmonia-project-db
DATABASE_URL=postgresql://postgres:postgres@127.0.0.1:54322/postgres
```

> The `DATABASE_URL` is displayed when running `bun start`. Look for the field called **DB URL**.

---

## ▶️ Running Supabase Locally

```sh
bun start # Starts Supabase locally
```

This will start the full local Supabase stack (PostgreSQL, Auth, Storage, Studio, etc.).

---

## 🧲 Migrations

To create a new migration using Drizzle ORM:

```sh
bun run gen:drizzle create-users-table
```

To create a new migration using Supabase CLI:

```sh
bun run gen:supabase enable-rls-users
```

To apply new migrations:

```sh
bun migrate
```

To reset the entire database (drops and re-applies all migrations + seed):

```sh
bun reset
```

> Always add new models or changes to `src/drizzle-schema.ts` so they are tracked.

We recommend creating all tables, columns, relations, and constraints using drizzle-schema.ts. Other database-level configurations such as RLS policies, roles, functions, or extensions should be created using Supabase CLI migrations (`supabase migration new`).

---

## 🧬 Generate Types & Zod Schemas

After making changes to your database, it’s recommended to update the generated types and Zod schemas to ensure type-safety in your application.

There are two options:

- **Generate from local Supabase database** (recommended during local dev):

```sh
bun gen
```

- **Generate from remote Supabase project** (useful when working with deployed schema):

```sh
bun gen:remote
```

These commands will:

- Generate `src/database.types.ts` using the Supabase CLI.
- Convert those types to `src/database.schemas.ts` using `supabase-to-zod`.

---

## 📦 Service Structure

```
services/supabase
├── migrations/              # SQL migrations generated by Drizzle or Supabase CLI
├── src/                     # Source code of the service
│   ├── database.schemas.ts  # Zod schemas generated from Supabase types
│   ├── database.types.ts    # TypeScript types generated from Supabase
│   ├── drizzle-schema.ts    # Database schema definitions using Drizzle ORM
│   └── index.ts             # Entry point to export everything from this service
├── .env                     # Local environment variables
├── .env.sample              # Example environment file
├── .gitignore               # Git ignore file
├── config.toml              # Supabase CLI configuration
├── drizzle.config.ts        # Drizzle ORM configuration
├── package.json             # Scripts and dependencies
├── seed.sql                 # Seed data used on reset
└── README.md                # This documentation file
```

---

## 🌱 Seed Data

You can define initial data for local development in `seed.sql`. This file is automatically run after `bun reset`.

---

## 🛠️ Useful Commands

| Command            | Description                                             |
| ------------------ | ------------------------------------------------------- |
| `bun start`        | Start Supabase local development environment            |
| `bun stop`         | Stop Supabase services                                  |
| `bun reset`        | Reset database and apply all migrations + seed          |
| `bun migrate`      | Apply new migrations without resetting the DB           |
| `bun gen:drizzle`  | Create a new Drizzle migration                          |
| `bun gen:supabase` | Create a new Supabase migration                         |
| `bun gen`          | Generate types and Zod schemas from local DB            |
| `bun gen:remote`   | Generate types and schemas from linked Supabase project |

---

## 📚 Docs

- [Supabase CLI Docs](https://supabase.com/docs/guides/local-development)
- [Drizzle ORM Docs](https://orm.drizzle.team/docs/overview)
